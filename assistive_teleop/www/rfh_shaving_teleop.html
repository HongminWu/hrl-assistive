<html>
<head>
  <title>Teleop Trial</title>
    <link type="text/css" href="css/rfh_interface.css" rel="stylesheet" />   
    <link type="text/css" href="jqueryui/css/sunny/jquery-ui-1.8.10.custom.css" rel="stylesheet" />   
    <script type="text/javascript" src="jqueryui/js/jquery-1.4.4.min.js"></script> 
    <script type="text/javascript" src="jqueryui/js/jquery-ui-1.8.10.custom.min.js"></script> 
    <script type="text/javascript" src="js/json2.js"></script>
    <script type="text/javascript" src="js/rosbridge.min.js"></script>
    <script type="text/javascript" src="ros/ros.js"> </script>
    <script type="text/javascript" src="js/rfh_teleop.js"> </script>
    <script type="text/javascript" src="js/rfh_shaving.js"> </script>
    <script type="text/javascript" src="js/rfh_clickable_video.js"> </script>

<script type="text/javascript">
function nop(){};
function json(obj){return JSON.stringify(obj);};
function log(message){ document.getElementById('console').innerHTML = message.toString();};
arm = function(){return $('input[name=arm_sel]:radio:checked').val()};

var ROBOT = 'monty1';

$(function(){
    $(':button').click(log_click);
	$('#force_view').slider({value:0,range:'min',min:0,max:12,step:0.05,orientation:'vertical'}); 
	$('#force_set').slider({value:1,min:0,max:12,step:0.05,orientation:'vertical'}); 
	$('#force_set').unbind("slidestop").bind("slidestop", function(event,ui){
                                                            pub_ft_goal($('#force_set').slider('value'));
                                                            log('Setting Force Threshold to '+ $('#force_set').slider("value").toString() + ' N ('+
                                                                0.01*Math.round(100*($('#force_set').slider("value")/4.44822)).toString()+' lbf)')
                                                            });	
	$('#rg_slider').slider({min:0,max:0.09,step:0.001,orientation:'vertical'}); 
	$('#rg_slider').unbind("slidestop").bind("slidestop", function(event,ui){
                                                            pub_gripper('r',$('#rg_slider').slider("value"));
                                                            log('Opening/Closing Right Gripper');
                                                            });	
	$('#lg_slider').slider({min:0,max:0.09,step:0.001,orientation:'vertical'}); 
	$('#lg_slider').unbind("slidestop").bind("slidestop", function(event,ui){
                                                            pub_gripper('l',$('#lg_slider').slider("value"));
                                                            log("Opening/Closing Left Gripper");
                                                            });	
	$('#torso_slider').slider({min:0.0,max:0.3,step:0.01,orientation:'vertical'});
	$('#torso_slider').unbind("slidestop").bind("slidestop",function(event,ui){
                                                            pub_torso($('#torso_slider').slider("value"))
                                                            });	
	$('#submit_text').click(function(e){speak($('#txt2say').val())});
	$('#slelect_plane').change(function(event,ui){window.plane = $('#select_plane').val()});
	$('.cont_sel').click(function(e){
                            $('.cont_sel').css('background-color','buttonface');
                            $(this).css('background-color', 'gray')
                            }); 
	$('#reset').hide(); 
});

function init(){
    init_subscribers();
    init_msgs();
    init_publishers();
    camera_init();
    teleop_init();
    shaving_init();
	log('Fully Initialized');
};


function init_msgs (){
    //log("Beginning Initialization");
	if (!window.point_2d){
        //log("Looking for Pixel_2_3d service");
		node.rosjs.callService('/rosbridge/reqClassFromTypeString',
                               '["pixel_2_3d/Pixel23d"]',
                               function(msg){window.point_2d=msg; init_msgs()});
	}else if (!window.gm_point){
        //log('PoseStamped Initialized, trying Geometry_msgs Point'); 
		node.rosjs.callService('/rosbridge/msgClassFromTypeString',
                               '["geometry_msgs/Point"]',
                               function(msg){window.gm_point=msg; init_msgs()});
	}else if (!window.JTAGoal){
        //log('Geometry_msgs Point Initialized, trying Joint Trajectory Action Goal');
		node.rosjs.callService('/rosbridge/msgClassFromTypeString',
                          '["pr2_controllers_msgs/JointTrajectoryActionGoal"]',
                          function(msg){window.JTAGoal=msg; init_msgs()});
	}else {
        //log('Joint Trajectory Action Goal Initialized, loading video'); 
        $('#force_view').slider("option", "disabled", true);
        set_camera("kinect_head/rgb/image_color");
	};
};

function init_subscribers() {
	node.subscribe('/r_gripper_controller_state_throttle',
                    function(msg){
                        $('#rg_slider').show().slider("option", "value", msg.process_value);
                    });
	node.subscribe('/l_gripper_controller_state_throttle',
                    function(msg){
                        $('#lg_slider').show().slider("option", "value", msg.process_value);
                    });
	node.subscribe('/torso_state_throttle',
                    function(msg){
                        window.torso_state = msg.actual.positions[0];
                        $('#torso_slider').show().slider("option", "value", msg.actual.positions[0])
                    });
	node.subscribe('/wt_log_out', function(msg){log(msg.data.toString())});
	
		//Move Arm Pose State
	node.subscribe('/wt_force_out_throttle',
                    function(ws){
                       mag = Math.sqrt(Math.pow(ws.wrench.force.x,2) + 
                                       Math.pow(ws.wrench.force.y,2) + 
                                       Math.pow(ws.wrench.force.z,2))
                        $('#force_view').slider("option", "value", mag);
                       set_ft_bar(Math.min(mag, 12)/12, 0.5);
                       $('#ft_readout').html('<p>'+mag.toFixed(1)+' N </p>')
                   });
};//END sub_state

function init_publishers() {
	//Gripper Publishers
    node.publish('wt_r_gripper_commands','pr2_controllers_msgs/Pr2GripperCommand',json({}));
	node.publish('wt_l_gripper_commands','pr2_controllers_msgs/Pr2GripperCommand',json({}));
    node.publish('wt_r_gripper_release_commands', 'std_msgs/Bool', json({}));
    node.publish('wt_l_gripper_release_commands', 'std_msgs/Bool', json({}));
    node.publish('wt_r_gripper_grab_commands', 'std_msgs/Bool',json({}));
    node.publish('wt_l_gripper_grab_commands', 'std_msgs/Bool',json({}));

   
    //Assorted Publishers
    node.publish('text_to_say', 'std_msgs/String', json({}));
	node.publish('torso_controller/position_joint_action/goal','pr2_controllers_msgs/SingleJointPositionActionGoal',json({}));
    node.publish('wt_ft_goal', 'std_msgs/Float32', json({}));
    node.publish('wt_click_log', 'std_msgs/String', json({}));
};

function log_click(event){
    node.publish('wt_click_log', 'std_msgs/String', json({'data':event.target.id.toString()}));
    //log(event.target.id);
};

function pub_ft_goal(thresh) {
    node.publish('wt_ft_goal', 'std_msgs/Float32', json({}));
};


function pub_gripper(arm,grpos) {
	//node.publish('wt_'+arm+'_gripper_commands',
	node.publish(arm+'_gripper_controller/command',
                 'pr2_controllers_msgs/Pr2GripperCommand',
                 json({'position': grpos ,'max_effort':-1}));
};

function gripper_grab(arm){
    pub_gripper(arm,0.0);
    //node.publish('wt_'+arm+'_gripper_grab_commands', 'std_msgs/Bool',
    //            json({'data':true}));
};

function gripper_release(arm){
    pub_gripper(arm,0.09);
    //node.publish('wt_'+arm+'_gripper_release_commands', 'std_msgs/Bool',
    //            json({'data':true}));
};

function pub_torso(tz){
    var dir = (tz < window.torso_state) ? 'Lowering' : 'Raising';
    log(dir+" Torso");
	node.publish('torso_controller/position_joint_action/goal',
                 'pr2_controllers_msgs/SingleJointPositionActionGoal',
                 json({'goal':{'position':tz}})
                )
};

function speak(text){
		node.publish('wt_speech', 'std_msgs/String', json({'data':text}));
		log('\"' + text +'\"'); 
};

function toggle_motors(command) { //command = 'halt' or 'reset'
	node.rosjs.callService('/pr2_etherCAT/'+command+'_motors', json(''), nop);
};


function start(){
    node = new ros.NodeHandle('ws://'+ ROBOT + ':9091');
	node.setOnClose(function(e) {
          log("Disconnected or Can't Connect to " + node.url + ".");
    	});
    	node.setOnError(function(e) {
          log("Unknown error connecting!");
    	});
      	node.setOnOpen(function(e) {   
	  log("Connected to " + node.url + ".");
	  init();
	  });
};

</script>
</head>
  <body onload="start()">
<table>
  <tr>
    <td colspan='7'> <!-- Start Cell for video -->
      <div id='video_container' style="position:relative; height:480; width:640;">
        <div style="position:absolute; height:100%; width:100%; left:0; top:0;" onclick="image_click(event);"> </div>
        <iframe id='video' title="Video Stream from the PR2" style="height:100%; width:100%; left:0; top:0; border-style:none;">You Broswer does not support iFrames</iframe>
      </div>
    </td><!-- End Cell for video -->
    <td>
      <div> <!-- Start Force-Torque Set/Feedback Block -->
      <table border=1>
        <tr>
          <td colspan=2 align='center'>Force</td>
        </tr><tr>
        </tr><tr>
          <td colspan=2 align='center'> 0-12 N </td>
        </tr><tr>
          <td align='center'><div id='force_set' style="height:360px"></div></td>
          <td align='center'><div id='force_view' style="height:360px"></div></td>
        </tr><tr>
          <td align='center'> Set </td>
          <td align='center'> Felt </td>
        </tr>
      </table>
      </div> <!-- End Force-Torque Set/Feedback Block -->
    </td>
    <td>
      <table border=1 style="height:450px; width:10px">
        <tr style="height:17%;background-color:red">
          <td>
           <p>Danger</p>
          </td>
        </tr>
        <tr style="height:58%;background-color:green">
          <td style="writing-mode:tb-rl;" >Activity</td>
        </tr>
        <tr style="height:25%;background-color:gray">
         <td>
           <div id="ft_readout"></div>
         </td>
        </tr>
      </table>
    </td>
    <td>
      <div id="ft_bar_wrapper">
        <div id="ft_bar_value">
        </div>
      </div>
    </td>
    <td>
      <table>
        <tr>
          <td>
            <button id="shave_start" class='act_menu' type="button" onclick="shave_start_cb()">Shave</button>
            <button id="shave_end" class='act_menu' type="button" onclick="shave_end_cb">End Shaving</button>
          </td>
       </tr>
       <tr><td><hr></td></tr>
       <tr><td>
         <button id="ar_servoing_setup" class='shave_acts' onclick="servo_setup_cb();"> Setup for Approach </button>
         <button id="ar_servoing_done" class='shave_acts' type="button" onclick="servoing_done_cb();"> Approach Finished </button>
         <button id="pc_snapshot" class='shave_acts' type="button" onclick="pc_snapshot_cb();"> Take Snapshot (In Rviz)</button>
          <button id="reg_confirm" class='shave_acts' type="button" style="height:120" onclick="reg_confirm_cb();"> Confirm Registration (Raise Torso and Untuck Arms) </button>
          <button id="shave" class='shave_acts' type="button" onclick="send_shave_location(-1);">Shave Now</button>
          </td>
        </tr>
      <tr>
        <td>
<div id='shave_select'>  <!--Shaving Selection Drop-Down and Entry -->
        <table id='shave_select'>
        <tr>
          <td>
            <select id='shave_list'>
              <option value=0>Chin</option>
              <option value=1>Mid-Cheek</option>
              <option value=2>Near Ear</option>
              <option value=3>Jaw</option>
              <option value=4>Mouth</option>
              <option value=5>Neck</option>
              <option value=6>High Cheek</option>
              <option value=7>Nose</option>
          <!--<option value=8>Mid-Cheek</option>
              <option value=9>Near Ear</option>
              <option value=10>Jaw</option>
              <option value=11>Mouth</option>
              <option value=12>Neck</option>
              <option value=13>High Cheek</option>-->
	        </select>
          </td>
          </tr><tr>
          <td><button id="send_shave_select" type="button" onclick="window.sm_selected_pose = document.getElementById('shave_list').selectedIndex; log('Sending Command to move to ' + document.getElementById('shave_list').options[window.sm_selected_pose].text); send_shave_location(window.sm_selected_pose)">Move to Selection</button></td>
	    </tr>
	</table>
  </div>  <!--End Shaving Drop-Down -->
  </td></tr>
      <tr><td><button  class='shave_acts' id="tool_power" type="button" value="-1" onclick="toggle_tool_power()">Start/Stop Razor</button></td></tr>
      <tr>
        <td><button id="rezero_wrench" class='shave_acts' type='button' onclick="rezero_wrench()";>Zero FT Sensor</button>
      </tr>
      </td>
      </table>
    <td>
  <tr>
    <td> Camera: </td> <!-- Start Cell for Camera Selection -->
	  <td><select onchange="set_camera($(this).val());">
	      <option value="kinect_head/rgb/image_color">Kinect Camera</option>
	      <option value="kinect_throttled">Throttled Kinect Camera</option>
	      <option value="arrow_overlaid">Kinect (w/Arrows)</option>
		  <option value="wide_stereo/right/image_color">Wide Stereo Camera</option>
		  <option value="l_forearm_cam/image_color_rotated">Left Forearm Camera</option>
		  <option value="r_forearm_cam/image_color_rotated">Right Forearm Camera</option>
      </select></td> <!-- End Cell for Camera Selection -->
     
     <td>On Image Click:</td> <!-- Start Cell for Image Action Selection -->
     <td><select id='img_act_select' onchange="window.img_act=$(this).val()">
         <option id="looking" selected='selected' value='looking'>Look</option>
         <option id="na" value='norm_approach'>Normal Approach</option>
         <option id="touch" value='touch'>Touch</option>
         <!--<option id="wipe" value='wipe'>Wipe</option>-->
         <!--<option id="swipe" value='swipe'>Swipe</option>-->
         <!--<option id="poke" value='poke'>Poke</option>-->
         <!--<option id="surf_wipe" value='surf_wipe'>Surface Wipe</option>-->
         <!--<option id="grasp" value='grasp'>Grasp</option>-->
         <!--<option id="reactive_grasp" value='reactive_grasp'>Reactive Grasp</option>-->
         <!--<option id="contact_approach" value='contact_approach'>Approach until Contact</option>-->
         <!--<option id="hfc_contact_approach" value='hfc_contact_approach'>Approach until Contact HFC</option>
         <option id="hfc_swipe" value='hfc_swipe'>Swipe HFC</option>
         <option id="hfc_wipe" value='hfc_wipe'>Wipe HFC</option>-->
     </select></td> <!-- End Cell for Image Action Selection -->
     <td>Hand:</td> <!-- Start Cell for Hand Selection -->
     <td>
        <div id='arm_sel'>
          <input type='radio' id='l_arm' name='arm_sel' value='left' checked='checked'"/><label for='l_arm'>Left</label>
          <input type='radio' id='r_arm' name='arm_sel' value='right'/><label for='r_arm'">Right</label>
        </div>
      </td>
  </tr>
  <!--<tr>
     <td colspan=2><button id="l_arm_controller" type="button" value="l_arm_controller" onclick="node.publish('wt_cont_switch', 'std_msgs/String', json({'data':'l_arm_controller'}));"> Joint Angle Controller (Default) </button></td>
     <td colspan=2><button id="l_cart" type="button" value="l_cart" onclick="node.publish('wt_cont_switch', 'std_msgs/String', json({'data':'l_cart'}));"> Hybrid Force Controller </button></td>
  </tr>-->
    
</table>
<!-- ABANDONED BUTTONS: DRIVING AND ARM TUCKING -->
<!--<div id="head_pos_out"></div>-->
<hr>
<div id="console"></div>
<hr>
<table><tr><td> <!-- Begin Gross Formatting-->
<div>
  <table>
    <tr><td colspan="2"><button class="cont_sel" id="cont_head" type="button" value="cont_head" onclick="teleop_head()">Control Head</button></td></tr>
    <tr>
       <td><button class="cont_sel" id="cont_l_arm" type="button" value="cont_l_arm" onclick="$('#l_arm').click(); teleop_arm();">Control Left Arm </button></td>
       <td><button class="cont_sel" id="cont_r_arm" type="button" value="cont_r_arm" onclick="$('#r_arm').click(); teleop_arm();">Control Right Arm </button></td>
    </tr>
    <tr>
       <td><button class="cont_sel" id="cont_l_hand" type="button" value="cont_l_hand" onclick="$('#l_arm').click(); teleop_wrist()">Control Left Hand</button></td>
       <td><button class="cont_sel" id="cont_r_hand" type="button" value="cont_r_hand" onclick="$('#r_arm').click(); teleop_wrist()">Control Right Hand </button></td>
    </tr>
    <tr><td colspan="2"><button class="cont_sel" id="cont_base" type="button" value="cont_base" onclick="teleop_base()">Control Base</button></td></tr>
    <tr>
    </tr>
 </table>
</div>
  <div id=speech_select>  <!--Speak Button and Text Input -->
        <table><tr>
          <form action=''>
             <td><button id="submit_text" type="button">Speak:</button></td>
             <td><input id="txt2say" type="text" style="height:auto;width:105%"/></td>
          </form>
        </tr>
	<tr>
	    <td>Phrases:</td>
	    <td><select onchange="speak($(this).val()); $('#txt2say').val($(this).val())">
		<option value="Yes">Yes</option>
		<option value="No">No</option>
		<option value="Maybe">Maybe</option>
		<option value="OK">Ok</option>
		<option value="k">k</option>
		<option value="Board Please">Board Please</option>
		<option value="I don't know">I Don't Know</option>
		<option value="I don't care">I Don't Care</option>
		<option value="One Moment">One Moment</option>
		<option value="Please">Please</option>
		<option value="Thank You">Thank You</option>
		<option value="I agree">I agree</option>
		<option value="I disagree">I disagree</option>
		<option value="A lot">A lot</option>
		<option value="A little">A little</option>
		<option value="Hello">Hello</option>
		<option value="Goodbye">Goodbye</option>
	    </select></td>
	</tr>
	</table>
  </div>  <!--End Speak Button + Text -->

</td><td> <!-- Gross Formatting-->

<div id='bpd1'> <!--Buttonpad Controls-->
  <table>
    <tr><td rowspan="4">
      <div style="height:215px" id="slider"></div>
    </td></tr>
    <tr>
      <td><button class="bpd" id="b7" type="button" value=1> Down </button></td>
      <td><button class="bpd" id="b8" type="button" value=1> ^ </button></td>
      <td><button class="bpd" id="b9" type="button" value=1> Up </button></td>
    </tr>
    <tr>
      <td><button class="bpd" id="b4" type="button" value="1"><</button></td>
      <td><button class="bpd" id="b5" type="button" value=1> 0 </button></td>
      <td><button class="bpd" id="b6" type="button" value="-1">></button></td>
    </tr>
    <tr>
      <td><button class="bpd" id="b1" type="button" value="-1">Turn Left</button></td>
      <td><button class="bpd" id="b2" type="button" value="-1">v</button></td>
      <td><button class="bpd" id="b3" type="button" value="-1">Turn Right</button></td>
    </tr>
  </table>
</div> <!--END buttonpad controls -->
</td><td>
<div id='bpd2'> <!--Buttonpad Controls-->
  <table>
    <tr><td rowspan="4">
      <div style="height:215px" id="slider"></div>
    </td></tr>
    <tr>
      <td><button class="bpd" id="bpd2_b7" type="button" value=1 onclick="shave_step(0,0,-1)"> Ellipse In </button></td>
      <td><button class="bpd" id="bpd2_b8" type="button" value=1 onclick="shave_step(0,1,0)"> ^ </button></td>
      <td><button class="bpd" id="bpd2_b9" type="button" value=1 onclick="shave_step(0,0,1)"> Ellipse Out </button></td>
    </tr>
    <tr>
      <td><button class="bpd" id="bpd2_b4" type="button" value="1" onclick="shave_step(-1,0,0)"><</button></td>
      <td><!--<button class="bpd" id="bpd2_b5" type="button" value=1 onclick="shave(0)"> Current </button>--></td>
      <td><button class="bpd" id="bpd2_b6" type="button" value="-1" onclick="shave_step(1,0,0)">></button></td>
    </tr>
    <tr>
      <td>
      <!--<button class="bpd" id="bpd2_b1" type="button" value=1 onclick="shave(-1)"> Prev. </button>-->
      </td>
      <td><button class="bpd" id="bpd2_b2" type="button" value="-1" onclick="shave_step(0,-1,0)">v</button></td>
      <td>
      <!--<button class="bpd" id="bpd2_b3" type="button" value=1 onclick="shave(1)"> Next </button>-->
      </td>
    </tr>
  </table>
</div> <!--END buttonpad controls -->
</td><td>
     <img id="tp" src=touchpad.jpg title="Click here for 2D Control of the selected robot part" style="border-style:solid; border-width:3px height:201px; width:201px;">
</td>
<td rowspan='4'> <!-- Gross Formatting-->
<div id='gripper_controls'>
  <table border='1'>
    <th colspan='2' align='center'> Grippers </th>
    <th align='center'>Torso</th>
    <tr>
      <td align='center'>Left</td>
      <td align='center'>Right</td>
      <td align='center'>U/D</td>
    </tr>
    <tr>
      <td>
        <button id='lg_release' onclick='gripper_release("l");'>Open</button>
      </td><td>
        <button id='rg_release' onclick='gripper_release("r");'>Open</button>
      </td><td>
        <button id='torso_max' onclick='pub_torso(0.3);'>Max</button>
      </td>
    </tr>
    <tr>
      <td rowspan="1" align='center'><div style="margin:5px;height:150px" id="lg_slider"></div></td>
      <td rowspan="1" align='center'><div style="margin:5px;height:150px" id="rg_slider"></div></td>
      <td rowspan="1" align='center'>
        <div style="margin: 5 auto; height:150px" id="torso_slider"></div>
      </td>
    </tr>
    <tr>
      <td>
        <button id='lg_grab' onclick='gripper_grab("l");'>Close</button>
      </td><td>
        <button id='rg_grab' onclick='gripper_grab("r");'>Close</button>
      </td><td>
        <button id='torso_min' onclick='pub_torso(0);'>Min</button>
      </td>
    </tr>
  </table>
</div>
</td>
</tr>
  <tr>
    <td colspan=4 align=right>
      <table class='ar_servo_controls'>
        <tr>
          <td>Approach Controls: </td>
          <td><button id='servo_detect_tag' style="font-size:150%;height:75;width:150" onclick="servo_detect_tag_cb();"> Detect Tag </button></td>
          <td><button id='servo_approach' style="font-size:150%;height:75;width:150" onclick="servo_approach_cb();"> Approach </button></td>
          <td><button id='servo_stop' style="font-size:150%;background-color:red;height:75;width:150" onclick="log('Stopping'); servo_preempt();"> Stop </button></td>
        </tr>
      </table>
    </td>
  </tr>
<tr><td colspan='4'> <!-- Gross Formating-->
<!--<div id="console"></div>-->
</td>
<td colspan='2'> <!-- Gross Formating-->
<tr><td colspan='4'>
  <button id="stop" type="button" style="color:red;background-color:gray;font:bold;height:auto;border-style:none;height:30px;width:100%;" onclick="toggle_motors('halt'); $(':button:visible:not(#reset)').fadeTo(0,0.4); $('#reset').show(); log('YOU\'VE STOPPED THE ROBOT! Please click \'REACTIVATE\' to reset.')">STOP ROBOT! </button> 
  </td>
</tr><tr>
  <td colspan='4'>
    <button id="reset" type="button" style="color:white;background-color:green;font:bold;height:30px;width:100%" onclick="toggle_motors('reset'); $(':button:visible').fadeTo(0,1); $(this).hide(); log('Operation Resumed.');">REACTIVATE</button>
 </td>
</tr></table> <!--END Gross Formating-->
</body>
</html>
