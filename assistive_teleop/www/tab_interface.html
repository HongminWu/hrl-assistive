<html>
<head>
  <title>Robots for Humanity Web Page</title>
    <link type="text/css" href="jqueryui/css/sunny/jquery-ui-1.8.10.custom.css" rel="stylesheet" />   
    <script type="text/javascript" src="jqueryui/js/jquery-1.4.4.min.js"></script> 
    <script type="text/javascript" src="jqueryui/js/jquery-ui-1.8.10.custom.min.js"></script> 
    <script type="text/javascript" src="js/json2.js"></script>
    <script type="text/javascript" src="js/rosbridge.min.js"></script>
    <script type="text/javascript" src="rosjs_common/js/common.js"> </script>
    <script type="text/javascript" src="js/rfh_teleop.js"> </script>
    <script type="text/javascript" src="js/rfh_shaving.js"> </script>
    <script type="text/javascript" src="js/rfh_clickable_video.js"> </script>
    <script type="text/javascript" src="js/mjpegcanvas.js"></script>
    <script type="text/javascript" src="js/force_level_widget.js"> </script>
    <script type="text/javascript" src="js/cart_control.js"> </script>
    <script type="text/javascript" src="js/traj_play.js"> </script>
    <link href="keyboard/css/keyboard.css" rel="stylesheet">
	<script src="keyboard/js/jquery.keyboard.js"></script>
    <link type="text/css" href="css/rfh_interface.css" rel="stylesheet" />   

<script type="text/javascript">
function nop(){};
function json(obj){return JSON.stringify(obj);};
function log(message){$('#console').html("<big><strong>"+message.toString()+"</strong></big>"); console.log(message.toString())};
//arm = function(){return $('input[name=arm_sel]:radio:checked').val()};

//var ROBOT = 'localhost';
var ROBOT = 'monty1.hsi.gatech.edu';
//var ROBOT = 'pr2c1.cc.gatech.edu';
var get_param_free = true;
var get_msgs_free = true;

$(function(){
    $("#txt2say").keyboard({layout:'qwerty', stayOpen:true});
    $("#tabs").tabs().tabs({select: tab_select_cb});
    $('#cont_sel_container').buttonset();
    $('label:first', '#cont_sel_container').removeClass('ui-corner-left').addClass('ui-corner-top centered');
    $('label:last', '#cont_sel_container').removeClass('ui-corner-right').addClass('ui-corner-bottom centered');
    //$('cont_sel_label').addClass('centered');
    $(".bpd, #cart_controller, .ar_servo_button, .traj_play_cont, #adj_mirror, #traj_play_reverse, #ell_controller, #reg_head, #rezero_wrench, #send_shave_select, #shave, #shave_stop, #tool_power").button();
    $('*').click(log_click);
	$('#submit_text').click(function(e){speak($('#txt2say').val())});
    $("#reset").hide();
});

function init(){
    console.log("Starting Init");
    mjpeg_canvas_init();
    traj_play_init();
    teleop_init();
    shaving_init();
    basic_init();
    cart_init();
    $('#cont_head').click();
	console.log('Finished Initialization');
};

function basic_init(){
    init_JTAGoal();
    //Services
    node.rosjs.callService('/rosbridge/reqClassFromTypeString',
                           '["pixel_2_3d/Pixel23d"]',
                           function(msg){window.point_2d=msg;});
    //Subscribers
	node.subscribe('/wt_log_out', function(msg){log(msg.data.toString())});
    //Publishers
    advertise('text_to_say', 'std_msgs/String');
	advertise('torso_controller/position_joint_action/goal',
                'pr2_controllers_msgs/SingleJointPositionActionGoal');
    advertise('wt_click_log', 'std_msgs/String');
};

function advertise(topic, type){
    node.publish(topic, type, json({}));
    console.log("Advertising "+topic+" of type: "+ type);
    };

function mjpeg_canvas_init(){
	var mjpeg = new MjpegCanvas({
		host:ROBOT,
        port:8080,
		topic : ['head_mount_kinect/rgb/image_color',
                 '/wide_stereo/right/image_rect_color',
                 '/r_forearm_cam/image_color',
                 '/l_forearm_cam/image_color'],
		label : ['Kinect Camera', 'Wide Stereo', 'Right Arm', 'Left Arm'],
		canvasID : 'mjpeg_canvas',
        defaultStream: 0,
		width: 640,
		height: 480,
        quality: 70
	});
};


function init_JTAGoal(){
	if (window.get_msgs_free){
        window.get_msgs_free = false;
        console.log('Locking for JTAGoal');
		node.rosjs.callService('/rosbridge/msgClassFromTypeString',
                          json(["pr2_controllers_msgs/JointTrajectoryActionGoal"]),
                          function(msg){window.JTAGoal=msg;
                                        window.get_msgs_free = true;
                                        console.log('Unlocking: Got JTAGoal');
                          });
	} else {
        console.log("JTAGoal Waiting for msg lock");
        setTimeout(function(){init_JTAGoal();},500);
    }
};

function log_click(event){
    node.publish('wt_click_log', 'std_msgs/String', json({'data':event.target.id.toString()}));
};

function list_opts(sel, dict){
    for (var key in dict){
        $(sel).append('<option value="'+dict[key]+'">'+key+'</option>');
        console.log("adding option "+ dict[key]+" to selector "+ sel)
        };
};

function list_key_opts(select, msg){
        $(select).empty();
        for (i=0; i<msg.data.length; i++){
            $(select).append('<option value="'+msg.data[i]+'">'+msg.data[i]+'</option>')};
    };

function empty_srv(service){
    console.log("Making Empty Call to "+service)
	node.rosjs.callService(service, json(''), nop);
    };

function tab_select_cb(eve, ui){
    if (ui.panel.id =='tab_ellipse'){
        set_camera('head_registration/confirmation');
    } else {
       toggle_ell_controller(false)}; 
    if (ui.panel.id =='tab_ar_servoing'){
        set_camera('ar_servo/confirmation_rotated')};
};

function speak(text){
		node.publish('wt_speech', 'std_msgs/String', json({'data':text}));
		log('\"' + text +'\"'); 
};

function start(){
    window.node = new ros.NodeHandle('ws://'+ ROBOT + ':9091');
	node.setOnClose(function(e) {
          log("Disconnected or Can't Connect to " + node.url + ".");
    	});
    	node.setOnError(function(e) {
          log("Unknown error connecting!");
    	});
      	node.setOnOpen(function(e) {   
	      log("Connected to " + node.url + ".");
	      init();
	    });
};

</script>
</head>
  <body onload="start()">
<table>
  <tr>
    <td colspan='7'> <!-- Start Cell for video -->
        <canvas id="mjpeg_canvas" width="640" height="480">Your browser does not support HTML5 canvas</canvas>
    </td><!-- End Cell for video -->
    <td>
      <div id="ft_view_widget"> </div>
    </td>
  <tr>
    <td> Camera: </td><td id="camera_select"></td>
     <td>On Image Click:</td><td id="image_click_select"></td>
     <td>Hand:</td>
     <!--<td>
        <div id='arm_sel'>
          <input type='radio' id='l_arm' name='arm_sel' value='left' checked='checked'/>
          <label for='l_arm'>Left</label>
          <input type='radio' id='r_arm' name='arm_sel' value='right'/>
          <label for='r_arm'>Right</label>
        </div>
      </td>-->
  </tr>
</table>
<hr>
<div id="console"></div>
<hr>

<table id="gross_formatting">
<tr>
<td>
<div id="tabs">
    <ul>
        <li><a href="#tab_cart_control">Default Controls</a></li>
        <li><a href="#tab_ar_servoing">AR Servoing</a></li>
        <li><a href="#tab_traj_play">Traj. Playback</a></li>
        <li><a href="#tab_ellipse">Ellipsoidal Control</a></li>
        <li><a href="#tab_tts">TTS</a></li>
    </ul>

    <div id="tab_cart_control">
      <table>
        <tr>
          <td>
            <table>
              <tr>
                <td colspan=2>
                  <div id='cont_sel_container' style="width:300px">
                    <div>
                      <input type="radio" class="cont_sel" id="cont_head" name="cont_sel" onclick="teleop_head()"/>
                      <label class="cont_sel_label" for="cont_head">Control Head</label>
                    </div><div>
                      <input type="radio" class="cont_sel" id="cont_l_arm" name="cont_sel" style="width:50%; height:100%"/>
                      <label class="cont_sel_label" for="cont_l_arm" style="width:50%; height:100%">Control Left Hand</label>
                      <input type="radio" class="cont_sel" id="cont_r_arm" name="cont_sel" style="width:50%; height:100%"/>
                      <label class="cont_sel_label" for="cont_r_arm" style="width:49.5%; height:100%">Control Right Hand</label>
                    </div><div>
                      <input type="radio" class="cont_sel" id="cont_base" name="cont_sel" onclick="teleop_base()">
                      <label class="cont_sel_label" for="cont_base">Control Base</label>
                    </div>
                  </div> 
                </td>
              </tr>
              <tr>
                 <td id='cart_frame_select_label'><b>Movement Frame:</b></td>
                 <td>
                   <select class="centered cart_control" id='cart_frame_select'>
                     <option id="frame_opt_torso" value="/torso_lift_link"> Torso </option> 
                     <option id="frame_opt_hand"> Hand </option> 
                   </select>
                 </td>
               </tr>
            </table>
          </td>
          <td>
            <div class="default_control" id='bpd_default'> <!-- Translate Cartesian Buttonpad-->
              <table>
                <tr>
                  <td rowspan="3">
                    <div class="slider" id="scale_slider" style="height:235px" ></div>
                  </td>
                  <td><button class="bpd arrow_trans_in" id="b7"/></td>
                  <td><button class="bpd arrow_trans_up" id="b8"/></td>
                  <td><button class="bpd arrow_trans_out" id="b9"/></td>
                </tr>
                <tr>
                  <td><button class="bpd arrow_trans_left" id="b4"/></td>
                  <td><button class="bpd" id="b5"/></td>
                  <td><button class="bpd arrow_trans_right" id="b6"/></td>
                </tr>
                <tr>
                  <td><button class="bpd" id="b1"/></td>
                  <td><button class="bpd arrow_trans_down" id="b2"/></td>
                  <td><button class="bpd" id="b3"/></td>
                </tr>
              </table>
            </div> <!--END Translate Cart Buttonpad -->
          </td>
          <td> 
            <div class="default_control" id='bpd_default_rot'> <!--Rotate Cart Buttonpad-->
              <table>
                <tr>
                  <td rowspan="3">
                    <div class="slider" id="default_rot_slider" style="height:235px" ></div>
                  </td>
                  <td><button class="bpd arrow_rot_x_neg" id="b7"/></td>
                  <td><button class="bpd arrow_rot_y_pos" id="b8"/></td>
                  <td><button class="bpd arrow_rot_x_pos" id="b9"/></td>
                </tr>
                <tr>
                  <td><button class="bpd arrow_rot_z_neg" id="b4"/></td>
                  <td><button class="bpd" id="b5"/></td>
                  <td><button class="bpd arrow_rot_z_pos" id="b6"/></td>
                </tr>
                <tr>
                  <td><button class="bpd" id="b1"/></td>
                  <td><button class="bpd arrow_rot_y_neg" id="b2"/>
                  <td><button class="bpd" id="b3"></td>
                </tr>
              </table>
            </div> <!--END Cart Rotate buttonpad -->
          </td>

       <!--<td>
         <img id="tp" src=touchpad.jpg title="Click here for 2D Control of the selected robot part" style="border-style:solid; border-width:3px height:235px; width:235px;">
       </td>-->
       </tr>
     </table>
    </div><!-- END TAB CART CONTROL -->

    <div id="tab_ar_servoing">
      <table>
        <tr>
          <td>
            <div>
              <!--<select id="ar_servo_select">
              </select>-->
            </div>
          </td>
        </tr>
        <tr>
          <td>
            <div>
              <table>
                <tr>
                  <td>
                    <button class='ar_servo_button' id='servo_detect_tag' style="font-size:140%" onclick="servo_detect_tag_cb();"> Detect Tag </button>
                  </td>
                  <td>
                    <button class='ar_servo_button' id='servo_approach' style="font-size:140%" onclick="servo_approach_cb();"> Approach </button>
                  </td>
                  <td>
                    <button class='ar_servo_button' id='servo_stop' style="font-size:140%" onclick="servo_preempt();"> Stop </button>
                  </td>
                </tr>
              </table>
            </div>
          </td>
        </tr>
      </table>
    </div><!-- END Tab Ar Servo -->
    
    <div id="tab_traj_play">
      <table id="traj_play_layout">
        <tr>
          <td>
            <table id="traj_play_selectors">
              <tr><th style="text-align:left">1. Activity</th></tr>
              <tr><td><select id="traj_play_act_sel"/></td></tr>
              <tr><th style="text-align:left">2. Arm</th></tr>
              <tr><td>
                <select id="traj_play_arm_sel"/>
                  <option value="Right">Right</option>
                  <option value="Left">Left</option>
              </td></tr>
              <tr><th style="text-align:left">3. Trajectory</th></tr>
              <tr><td><select id="traj_play_select"/></td></tr>
            </table>
          </td>
          <td>
            <table id="traj_play_buttons">
              <tr><td>
                  <button class="centered traj_play_cont" id='traj_play_play' style="font-size:150%" onclick="traj_play_send_goal();"> Play </button>
              </td></tr>
              <tr><td>
                  <button class="centered traj_play_cont" id='traj_play_stop' style="font-size:150%" onclick="empty_srv('/trajectory_playback_r_pause');empty_srv('/trajectory_playback_l_pause');"> Pause </button>
              </td></tr>
              <tr><td>
                  <button class="centered traj_play_cont" id='traj_play_reset' style="font-size:150%" onclick="empty_srv('/trajectory_playback_r_stop');empty_srv('/trajectory_playback_l_stop')"> Stop </button>
              </td></tr>
            </table>
          </td>
          <td>
            <form id="traj_play_radio">
              <table>
                <tr>
                  <td>
                    <div id="traj_radio">
                    <div>
                    <input type="radio" id="traj_play_setup" value='1' name="traj_radio"/>
                    <label class="traj_play_radio_label" for="traj_play_setup"> Move to Setup </label>
                    </div>
                    <div>
                    <input type="radio" id="traj_play_exec" value="2" name="traj_radio">
                    <label class="traj_play_radio_label" for="traj_play_exec"> Execute Traj. </label>
                    </div>
                    <div>
                    <input type="radio" id="traj_play_set_and_exec" value="3" name="traj_radio" checked="checked"/>
                    <label class="traj_play_radio_label" for="traj_play_set_and_exec"> Setup AND Execute </label>
                    </div>
                  </div>
                </td></tr>
              </table>
            </form>
          </td>
        </tr>
      </table>
    </div> <!-- End Tab Traj Playbak -->

    <div id="tab_ellipse">
      <table>
        <tr>
          <td>
            <table>
              <tr>
                <td>
                  <button class="centered" id="reg_head" onclick="head_reg_cb()"> Register Head </button>
                </td>
              <tr>
              <tr>
                <td>
                  <select class="centered" id="ell_mode_sel"> 
                    <option id="mode_opt_wiping" value="wiping" selected="selected"> Wiping </option>
                    <option id="mode_opt_shaving" value="shaving"> Shaving </option>
                    <option id="mode_opt_scratching" value="scratching"> Scratching </option>
                    <option id="mode_opt_feeding" value="feeding"> Feeding </option>
                  </select>
                </td>
              <tr>
                <td>
                  <input type="checkbox" class="centered ell_control" id="ell_controller" onclick="toggle_ell_controller()" />
                  <label id="ell_cont_state_check" for="ell_controller">Ellipsoid Controller</label>
                </td>
              </tr>
              <tr>
                <td>
                  <button class="centered ell_control" id="adj_mirror" onclick="adj_mirror_cb()"> Adjust Mirror </button>
                </td>
              </tr>
              <tr>
              <tr>
                <td>
                   <button class="centered ell_control" id="tool_power" onclick="toggle_tool_power()">Start/Stop Razor</button>
                </td>
              <tr>
              </tr>
                <td>
                  <button class='centered ell_control' id="rezero_wrench" onclick="rezero_wrench()";>Zero FT Sensor</button>
                </td>
              </tr>
              <tr>
                <td>
                  <div id='shave_select'>  <!--Shaving Selection Drop-Down and Entry -->
                    <table class='centered' frame=box rules=none border=3>
                    <tr>
                      <td>
                        <select class="centered ell_control" id='shave_list'></select>
                      </td>
                      </tr><tr>
                      <td><button class="centered ell_control" id="send_shave_select" onclick="console.log('Sending Command to move to '+$('#shave_list option:selected').text()); send_shave_location($('#shave_list option:selected').text())">Move to Selection</button></td>
                    </tr>
                  </table>
                </div>  <!--End Shaving Drop-Down -->
              </td>
            </tr>
            <tr>
                      <td><button class="centered ell_control" id="shave_stop" onclick="shave_stop();">Stop</button></td>
               </td>
             </tr>
            </table>
          </td>
          <td>
            <div class="ell_control" id='bpd_ell_trans'> <!-- Translate Ellipse Buttonpad-->
              <table>
                <tr>
                  <th colspan="4"> Translate </th>
                </tr>
                <tr><td rowspan="4">
                  <div class="slider" id="ell_trans_slider" style="height:235px" ></div>
                </td></tr>
                <tr>
                  <td><button class="bpd arrow_trans_in" id="b7" value=1 onclick="shave_step('translate_in')"/></td>
                  <td><button class="bpd arrow_trans_up" id="b8" value=1 onclick="shave_step('translate_up')"/></td>
                  <td><button class="bpd arrow_trans_out" id="b9" value=1 onclick="shave_step('translate_out')"/></td>
                </tr>
                <tr>
                  <td><button class="bpd arrow_trans_left" id="b4" value="1" onclick="shave_step('translate_left')"/></td>
                  <td><img id="gripper_icon" src="css/arrows/gripper_icon.png" /></td>
                  <td><button class="bpd arrow_trans_right" id="b6" value="-1" onclick="shave_step('translate_right')"/></td>
                </tr>
                <tr>
                  <td><!--<button class="bpd" id="b1" onclick="shave_step()"/>--></td>
                  <td><button class="bpd arrow_trans_down" id="b2" onclick="shave_step('translate_down')"/></td>
                  <td><!--<button class="bpd" id="b3" onclick="shave(1)"/>--></td>
                </tr>
              </table>
            </div> <!--END Translate Ellipse Buttonpad -->
          </td>
          <td> 
            <div class="ell_control" id='bpd_ell_rot'> <!--Rotate Ellipse Buttonpad-->
              <table>
                <tr>
                  <th colspan="4"> Rotate </th>
                </tr>
                <tr><td rowspan="4">
                  <div class="slider" id="ell_rot_slider" style="height:235px" ></div>
                </td></tr>
                <tr>
                  <td><button class="bpd arrow_rot_x_pos" id="b7" value=1 onclick="shave_step('rotate_x_pos')"/></td>
                  <td><button class="bpd arrow_rot_y_pos" id="b8" value=1 onclick="shave_step('rotate_y_pos')"/></td>
                  <td><button class="bpd arrow_rot_x_neg" id="b9" value=1 onclick="shave_step('rotate_x_neg')"/></td>
                </tr>
                <tr>
                  <td><button class="bpd arrow_rot_z_pos" id="b4" value="1" onclick="shave_step('rotate_z_pos')"/></td>
                  <td><img id="gripper_icon" src="css/arrows/gripper_icon.png" /></td>
                  <td><button class="bpd arrow_rot_z_neg" id="b6" value="-1" onclick="shave_step('rotate_z_neg')"/></td>
                </tr>
                <tr>
                  <td><button class="bpd" id="b1" value=1 onclick="shave_step('reset_rotation')">Reset </button></td>
                  <td><button class="bpd arrow_rot_y_neg" id="b2" onclick="shave_step('rotate_y_neg')"/>
                  <td><!--<button class="bpd" id="b3" onclick="shave(1)"/>--></td>
                </tr>
              </table>
            </div> <!--END Ellipse Rotate buttonpad -->
          </td>
        </tr>
      </table>
    </div><!--END Tab ellipse -->

    <div id="tab_tts">
      <div id=speech_select>  <!--Speak Button and Text Input -->
        <table>
          <tr>
            <form action=''>
              <td>
                <button id="submit_text" type="button">Speak:</button>
              </td>
              <td> 
                <input id="txt2say" type="text" style="height:auto;width:105%"/>
              </td>
            </form>
          </tr>
          <tr>
            <td>Phrases:</td>
            <td>
              <select onchange="speak($(this).val()); $('#txt2say').val($(this).val())">
                <option value="Yes">Yes</option>
                <option value="No">No</option>
                <option value="Maybe">Maybe</option>
                <option value="OK">Ok</option>
                <option value="k">k</option>
                <option value="Board Please">Board Please</option>
                <option value="I don't know">I Don't Know</option>
                <option value="I don't care">I Don't Care</option>
                <option value="One Moment">One Moment</option>
                <option value="Please">Please</option>
                <option value="Thank You">Thank You</option>
                <option value="I agree">I agree</option>
                <option value="I disagree">I disagree</option>
                <option value="A lot">A lot</option>
                <option value="A little">A little</option>
                <option value="Hello">Hello</option>
                <option value="Goodbye">Goodbye</option>
              </select>
            </td>
          </tr>
        </table>
      </div>  <!--End Speak Button + Text -->
    </div> <!--END Tab TTS -->
  </div> <!-- END Tabs -->
</td>
    
<td rowspan='4'> <!-- Gross Formatting-->
<div id='gripper_controls'>
  <table border='1'>
    <th colspan='2' align='center'> Grippers </th>
    <th align='center'>Torso</th>
    <tr>
      <td align='center'>Left</td>
      <td align='center'>Right</td>
      <td align='center'>U/D</td>
    </tr>
    <tr>
      <td>
        <button id='lg_release'>Open</button>
      </td><td>
        <button id='rg_release'>Open</button>
      </td><td>
        <button id='torso_max' onclick='pub_torso(0.3);'>Max</button>
      </td>
    </tr>
    <tr>
      <td rowspan="1" align='center'><div style="margin:5px;height:150px" class="slider" id="lg_slider"></div></td>
      <td rowspan="1" align='center'><div style="margin:5px;height:150px" class="slider" id="rg_slider"></div></td>
      <td rowspan="1" align='center'>
        <div style="margin: 5 auto; height:150px" class="slider" id="torso_slider"></div>
      </td>
    </tr>
    <tr>
      <td>
        <button id='lg_grab'>Close</button>
      </td><td>
        <button id='rg_grab'>Close</button>
      </td><td>
        <button id='torso_min' onclick='pub_torso(0);'>Min</button>
      </td>
    </tr>
  </table>
</div>
</td>
</tr>
  <tr>
    <td colspan=4 align=right>
    </td>
  </tr>
<tr><td colspan='4'> <!-- Gross Formating-->
<!--<div id="console"></div>-->
</td>
<td> <!-- Gross Formating-->
<tr><td>
  <button id="stop" type="button" style="color:red;background-color:gray;font:bold;height:auto;border-style:none;height:30px;width:100%;" onclick="empty_srv('/pr2_etherCAT/halt_motors'); $(':button:visible:not(#reset)').fadeTo(0,0.4); $('#reset').show(); log('YOU\'VE STOPPED THE ROBOT! Please click \'REACTIVATE\' to reset.')">STOP ROBOT! </button> 
  </td>
</tr><tr>
  <td>
    <button id="reset" type="button" style="color:white;background-color:green;font:bold;height:30px;width:100%" onclick="empty_srv('/pr2_etherCAT/reset_motors'); $(':button:visible').fadeTo(0,1); $(this).hide(); log('Operation Resumed.');">REACTIVATE</button>
 </td>
</tr>
</table> <!--END Gross Formating-->
</body>
</html>
