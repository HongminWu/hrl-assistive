<html>
<head>
  <title>Teleop Trial</title>
    <link type="text/css" href="jqueryui/css/sunny/jquery-ui-1.8.10.custom.css" rel="stylesheet" />   
    <script type="text/javascript" src="jqueryui/js/jquery-1.4.4.min.js"></script> 
    <script type="text/javascript" src="jqueryui/js/jquery-ui-1.8.10.custom.min.js"></script> 
    <script type="text/javascript" src="js/json2.js"></script>
    <script type="text/javascript" src="js/rosbridge.min.js"></script>
    <script type="text/javascript" src="ros/ros.js"> </script>

<script type="text/javascript">
function nop(){};
function json(obj){return JSON.stringify(obj);};
function log(message){ document.getElementById('console').innerHTML = message.toString();};

var ROBOT = 'monty1.hsi.gatech.edu';
//var ROBOT = 'localhost'
var head_pub;
var base_pub;
var scales={head:50,base:50,rarm:50,larm:50,rwrist:50,lwrist:50};
var arm_joints={right:[],left:[]}
var bx=by=bz=count_surf_wipe_right=count_surf_wipe_left=force_wipe_count=0;
var img_act = 'looking'
var norm_appr_left = norm_appr_right = driving = tool_state = false;
arm = function(){return $('input[name=arm_sel]:radio:checked').val()};
var plane = 'xy';
var head_state;
var torso_state;
var pointing_frame='wide_stereo_optical_frame'

$(function(){
	$('#slider').slider({value:50,min:0,max:100,step:1,orientation:'vertical'}); 
	$('#force_view').slider({value:0,range:'min',min:0,max:15,step:0.05,orientation:'vertical'}); 
	$('#force_set').slider({value:1,min:0,max:15,step:0.05,orientation:'vertical'}); 
	$('#force_set').unbind("slidestop").bind("slidestop", function(event,ui){
                                                            pub_ft_goal($('#force_set').slider('value'));
                                                            log('Setting Force Threshold to '+ $('#force_set').slider("value").toString() + ' N ('+
                                                                0.01*Math.round(100*($('#force_set').slider("value")/4.44822)).toString()+' lbf)')
                                                            });	
	$('#rg_slider').slider({min:0,max:0.09,step:0.001,orientation:'vertical'}); 
	$('#rg_slider').unbind("slidestop").bind("slidestop", function(event,ui){
                                                            pub_gripper('r',$('#rg_slider').slider("value"));
                                                            log('Opening/Closing Right Gripper');
                                                            });	
	$('#lg_slider').slider({min:0,max:0.09,step:0.001,orientation:'vertical'}); 
	$('#lg_slider').unbind("slidestop").bind("slidestop", function(event,ui){
                                                            pub_gripper('l',$('#lg_slider').slider("value"));
                                                            log("Opening/Closing Left Gripper");
                                                            });	
	$('#torso_slider').slider({min:0.0,max:0.3,step:0.01,orientation:'vertical'});
	$('#torso_slider').unbind("slidestop").bind("slidestop",function(event,ui){
                                                            pub_torso($('#torso_slider').slider("value"))
                                                            });	
	$('#submit_text').click(function(e){speak($('#txt2say').val())});
	$("body").find('*').mouseup(function(e){window.bx=0; window.by=0; window.bz=0});
	$('#slelect_plane').change(function(event,ui){window.plane = $('#select_plane').val()});
	$('.cont_sel').click(function(e){
                            $('.cont_sel').css('background-color','buttonface');
                            $(this).css('background-color', 'gray')
                            }); 
    $('.shave_acts').hide();
	$('#reset, #bpd2, #shave_end, #shave_select').hide(); 
});

function init(){
    init_subscribers();
    init_msgs();
    init_publishers();
};

function init_msgs (){
    log("Beginning Initialization");
	if (!window.point_2d){
        log("Looking for Pixel_2_3d service");
		node.rosjs.callService('/rosbridge/reqClassFromTypeString',
                                '["pixel_2_3d/Pixel23d"]',
                                function(msg){window.point_2d = msg; init()});
	}else if (!window.gm_point){
        log('PoseStamped Initialized, trying Geometry_msgs Point'); 
		node.rosjs.callService('/rosbridge/msgClassFromTypeString',
                                '["geometry_msgs/Point"]',
                                function(msg){window.gm_point = msg; init()});
	}else if (!window.JTAGoal){
        log('Geometry_msgs Point Initialized, trying Joint Trajectory Action Goal');
		node.rosjs.callService('/rosbridge/msgClassFromTypeString',
                                '["pr2_controllers_msgs/JointTrajectoryActionGoal"]',
                                function(msg){window.JTAGoal = msg; init()});
	}else {
        log('Joint Trajectory Action Goal Initialized, loading video'); 
        $('#force_view').slider("option", "disabled", true);
        set_camera("/wide_stereo/right/image_color");
	log('Fully Initialized');
	};
};

function init_subscribers() {
	node.subscribe('/head_traj_controller_state_throttle',
                    function(msg){
                        window.head_state = msg.actual;
                        window.head_joints = msg.joint_names;
                        document.getElementById('head_pos_out').innerHTML='Head Position: Left/Right:\ \ ' + 
                            Math.round(-window.head_state.positions[0]*180/Math.PI) + '\ deg.\ \ Up/Down:' + 
                            Math.round(-window.head_state.positions[1]*180/Math.PI) + '\ deg.'
			        });
	node.subscribe('/r_gripper_controller_state_throttle',
                    function(msg){
                        $('#rg_slider').show().slider("option", "value", msg.process_value);
                    });
	node.subscribe('/l_gripper_controller_state_throttle',
                    function(msg){
                        $('#lg_slider').show().slider("option", "value", msg.process_value);
                    });
	node.subscribe('/torso_state_throttle',
                    function(msg){
                        window.torso_state = msg.actual.positions[0];
                        $('#torso_slider').show().slider("option", "value", msg.actual.positions[0])
                    });
	node.subscribe('/wt_log_out', function(msg){log(msg.data.toString())});
	
		//Move Arm Pose State
	node.subscribe('/r_arm_controller_state_throttle', function(msg){
                                        window.arm_joints.right = msg.actual});
	node.subscribe('/l_arm_controller_state_throttle', function(msg){
                                        window.arm_joints.left = msg.actual});
//	node.subscribe('/wt_force_out_throttle',
//                    function(ws){$('#force_view').slider("option", "value",
//                    Math.sqrt(Math.pow(ws.wrench.force.x,2) + 
//                    Math.pow(ws.wrench.force.y,2) + 
//                    Math.pow(ws.wrench.force.z,2)))
//                   });
	//node.subscribe('/ros_switch_state', function(msg){
    //                window.tool_state=msg.data;
    //              });
};//END sub_state

function init_publishers() {
	//Gripper Publishers
    node.publish('wt_r_gripper_commands','pr2_controllers_msgs/Pr2GripperCommand',json({}));
	node.publish('wt_l_gripper_commands','pr2_controllers_msgs/Pr2GripperCommand',json({}));
    node.publish('wt_r_gripper_release_commands', 'std_msgs/Bool', json({}));
    node.publish('wt_l_gripper_release_commands', 'std_msgs/Bool', json({}));
    node.publish('wt_r_gripper_grab_commands', 'std_msgs/Bool',json({}));
    node.publish('wt_l_gripper_grab_commands', 'std_msgs/Bool',json({}));

    //Arm Publishers
    node.publish('wt_right_arm_pose_commands','geometry_msgs/Point', json({}));
    node.publish('wt_left_arm_pose_commands','geometry_msgs/Point', json({}));
    node.publish('wt_right_arm_angle_commands', 'trajectory_msgs/JointTrajectoryPoint', json({}))
    node.publish('wt_left_arm_angle_commands', 'trajectory_msgs/JointTrajectoryPoint', json({}))
    node.publish('wt_lin_move_right','std_msgs/Float32', json({}));
    node.publish('wt_lin_move_left','std_msgs/Float32', json({}));
    //node.publish('wt_tuck_arms', 'std_msgs/String', json({}));
   
    //Image-Click Publishers
    node.publish('norm_approach_right', 'geometry_msgs/PoseStamped', json({}));
    node.publish('norm_approach_left', 'geometry_msgs/PoseStamped', json({}));
    node.publish('wt_contact_approach_right', 'geometry_msgs/PoseStamped', json({}));
    node.publish('wt_contact_approach_left', 'geometry_msgs/PoseStamped', json({}));
    node.publish('wt_poke_right_point', 'geometry_msgs/PoseStamped', json({}));
    node.publish('wt_poke_left_point', 'geometry_msgs/PoseStamped', json({}));
    node.publish('wt_swipe_right_goals', 'geometry_msgs/PoseStamped', json({}));
    node.publish('wt_swipe_left_goals', 'geometry_msgs/PoseStamped', json({}));
    node.publish('wt_wipe_right_goals', 'geometry_msgs/PoseStamped', json({}));
    node.publish('wt_wipe_left_goals', 'geometry_msgs/PoseStamped', json({}));
    node.publish('wt_rg_right_goal', 'geometry_msgs/PoseStamped', json({}));
    node.publish('wt_rg_left_goal', 'geometry_msgs/PoseStamped', json({}));
    node.publish('wt_grasp_right_goal', 'geometry_msgs/PoseStamped', json({}));
    node.publish('wt_grasp_left_goal', 'geometry_msgs/PoseStamped', json({}));
    node.publish('wt_surf_wipe_r_points', 'geometry_msgs/Point', json({}));
    node.publish('wt_surf_wipe_l_points', 'geometry_msgs/Point', json({}));
   
    //Wrist Publishers
    node.publish('wt_adjust_elbow_right','std_msgs/Float32', json({}));
    node.publish('wt_adjust_elbow_left','std_msgs/Float32', json({}));

    //Head Publishers
    node.publish('head_nav_goal', 'geometry_msgs/PoseStamped', json({}));
    node.publish('head_traj_controller/joint_trajectory_action/goal','pr2_controllers_msgs/JointTrajectoryActionGoal', json({}));
	node.publish('head_traj_controller/point_head_action/goal', 'pr2_controllers_msgs/PointHeadActionGoal', json({}));
    
    //Assorted Publishers
    node.publish('base_controller/command', 'geometry_msgs/Twist',json({}));
    node.publish('text_to_say', 'std_msgs/String', json({}));
	node.publish('torso_controller/position_joint_action/goal','pr2_controllers_msgs/SingleJointPositionActionGoal',json({}))
    node.publish('wt_ft_goal', 'std_msgs/Float32', json({}))
    
    //Shaving Publishers
    node.publish('wt_disc_shaving_step', 'std_msgs/Int8', json({}));
    node.publish('wt_cont_shaving_step', 'geometry_msgs/Point', json({}));
    node.publish('wt_shave_location', 'std_msgs/Int8', json({}));
    node.publish('reg_confirm', 'std_msgs/Bool', json({}))
    node.publish('ros_switch', 'std_msgs/Bool', json({}));
    node.publish('init_head', 'geometry_msgs/PoseStamped', json({}));

};

function pub_ft_goal(thresh) {
    node.publish('wt_ft_goal', 'std_msgs/Float32', json({}));
};

function click_position(e) {
	var posx = 0;
	var posy = 0;
	if (!e) var e = window.event;
	if (e.pageX || e.pageY) 	{
		posx = e.pageX;
		posy = e.pageY;
	}
	else if (e.clientX || e.clientY) 	{
		posx = e.clientX + document.body.scrollLeft
			+ document.documentElement.scrollLeft;
		posy = e.clientY + document.body.scrollTop
			+ document.documentElement.scrollTop;
	}	return [posx,posy]
};

function get_point(event){
	var point = click_position(event);
	click_x = point[0] - document.getElementById('video_container').offsetLeft 
	click_y = point[1] - document.getElementById('video_container').offsetTop 
	//log("Clicked on point (x,y) = ("+ click_x.toString() +","+ click_y.toString()+")");
	return [click_x, click_y]
};

function image_click(event){
	var im_pixel = get_point(event);
	if (window.img_act == 'surf_wipe') {
    surf_points_out = window.gm_point
    surf_points_out.x = im_pixel[0]
    surf_points_out.y = im_pixel[1]
    log('Surface Wipe');
        log('Surface Wipe '+window.arm().toUpperCase()+' '+window.count_surf_wipe_right.toString())
        node.publish('wt_surf_wipe_'+window.arm()+'_points', 'geometry_msgs/Point', json(surf_points_out));
        if (window.count_surf_wipe == 0){
           log("Sending start position for surface-aware wiping");
           window.count_surf_wipe = 1;
        } else if (window.count_surf_wipe == 1){
           log("Sending end position for surface-aware wiping");
           window.count_surf_wipe = 0;
           $('#img_act_select').val('looking');
           window.img_act = 'looking';
        }
    }else{
	get_im_3d(im_pixel[0],im_pixel[1])
	};
};

function get_im_3d(x,y){
	window.point_2d.pixel_u = x;
	window.point_2d.pixel_v = y;
    log('Sending Pixel_2_3d request, awaiting response');
	node.rosjs.callService('/pixel_2_3d',
                            '['+json(window.point_2d.pixel_u)+','+json(window.point_2d.pixel_v)+']',
                            function(msg){
                                log('pixel_2_3d response received');
                                point_3d=msg.pixel3d;
                                determine_p23d_response(point_3d)
                            })
};

function determine_p23d_response(point_3d){
    switch (window.img_act){
        case 'looking':
            log("Sending look to point command");
            window.head_pub = window.clearInterval(head_pub);
            pub_head_goal(point_3d.pose.position.x, point_3d.pose.position.y, point_3d.pose.position.z, point_3d.header.frame_id);
            break
        case 'head_nav_goal':
                log("Sending navigation seed position");
                node.publish('head_nav_goal', 'geometry_msgs/PoseStamped', json(point_3d));
                break
        case 'init_head_cloud':
                log("Sending Initial Position for Head Model");
                node.publish('init_head', 'geometry_msgs/PoseStamped', json(point_3d));
                break
        case 'norm_approach':
            log('Sending '+window.arm().toUpperCase()+ ' Arm Normal Approach Command')
            node.publish('norm_approach_'+window.arm(), 'geometry_msgs/PoseStamped', json(point_3d));
            break
        case 'grasp':
            log('Sending command to attempt to grasp object with '+window.arm().toUpperCase()+' arm')
            node.publish('wt_grasp_'+window.arm()+'_goal', 'geometry_msgs/PoseStamped', json(point_3d));
            break
        case 'reactive_grasp':
            log('Sending command to grasp object with reactive grasping with '+window.arm().toUpperCase()+' arm');
            node.publish('wt_rg_'+window.arm()+'_goal', 'geometry_msgs/PoseStamped', json(point_3d));
            break
        case 'wipe':
            node.publish('wt_wipe_'+window.arm()+'_goals', 'geometry_msgs/PoseStamped', json(point_3d));
            if (window.force_wipe_count == 0) {
                window.force_wipe_count = 1;
                log('Sending start position for force-sensitive wiping')
            } else if (window.force_wipe_count == 1) {
                window.force_wipe_count = 0;
                log('Sending end position for force-sensitive wiping')
            };    
            break
        case 'swipe':
            log('Sending command to swipe from start to finish with '+window.arm().toUpperCase+' arm')
            node.publish('wt_swipe_'+window.arm()+'_goals', 'geometry_msgs/PoseStamped', json(point_3d));
            break
        case 'poke':
            log('Sending command to poke point with '+window.arm().toUpperCase()+' arm')
            node.publish('wt_poke_'+window.arm()+'_point', 'geometry_msgs/PoseStamped', json(point_3d));
            break
        case 'contact_approach':
            log('Sending command to approaching point by moving until contact with '+window.arm().toUpperCase()+' arm')
            node.publish('wt_contact_approach_'+window.arm(), 'geometry_msgs/PoseStamped', json(point_3d));
        };
        if (window.force_wipe_count == 0){
            $('#img_act_select').val('looking');
            window.img_act = 'looking';
        };
};


function pub_lin_move(){
    node.publish('wt_lin_move_'+window.arm(),'std_msgs/Float32', json({"data":window.lin_move}));
    log('Sending '+window.arm().toUpperCase()+' Hand Advance/Retreat command');
};

function control_arm(x,y,z){
	goal = window.gm_point;
    goal.x = x;
    goal.y = y;
    goal.z = z;
    log('Sending command to '+window.arm().toUpperCase()+' arm');
    node.publish('wt_'+window.arm()+'_arm_pose_commands',
                 'geometry_msgs/Point', json(goal));
};

function pub_gripper(arm,grpos) {
	node.publish('wt_'+arm+'_gripper_commands',
                 'pr2_controllers_msgs/Pr2GripperCommand',
                 json({'position': grpos ,'max_effort':-1}));
};

function gripper_grab(arm){
    node.publish('wt_'+arm+'_gripper_grab_commands', 'std_msgs/Bool',
                json({'data':true}));
};

function gripper_release(arm){
    node.publish('wt_'+arm+'_gripper_release_commands', 'std_msgs/Bool',
                json({'data':true}));
};

function teleop_arm() {
	var x,y,z,b9txt,b7txt;
	if (plane == 'xy'){
        x=0;
        y=1;
        z=2;
        b9txt='Up';
        b7txt='Down'
    } else if (plane == 'yz') {
        x=2;
        y=1;
        z=0;
        b9txt='Further Away';
        b7txt='Closer'
    };

    log('Controlling '+window.arm().toUpperCase()+' Arm');
    $('#slider').unbind("slidestop");
    $('#slider').bind("slidestop", function(event,ui){scales[window.arm()[0]+'arm'] = $('#slider').slider("value")});
    $('#slider').show().slider("option", "value", scales[window.arm()[0]+'arm']);

    $("#tp").unbind().show();
    $("#tp").click(function(e){
        y = -(e.pageX - Math.round(this.width/2) - this.x)/500;
        x = -(e.pageY - Math.round(this.height/2) - this.y)/500;
        control_arm(x,y,0);	
    });

    $('.bpd').unbind();
    $('#b9').show().text(b9txt).click(function(e){
        control_arm(0,0,scales[window.arm()[0]+'arm']/500);
    });
    $('#b8').show().text("^").click(function(e){
        control_arm(scales[window.arm()[0]+'arm']/500,0,0);
    });
    $('#b7').show().text(b7txt).click(function(e){
        control_arm(0,0,-scales[window.arm()[0]+'arm']/500);
    });
    $('#b6').show().text(">").click(function(e){
        control_arm(0,-scales[window.arm()[0]+'arm']/500,0);
    });
    $('#b5').hide()
    $('#b4').show().text("<").click(function(e){
        control_arm(0,scales[window.arm()[0]+'arm']/500,0);
    });
    $('#b3').show().text("Advance").click(function(e){
        window.lin_move=0.1*(scales[window.arm()[0]+'arm']/100);
        pub_lin_move();
    });
    $('#b2').show().text("v").click(function(e){
        control_arm(-scales[window.arm()[0]+'arm']/500,0,0);
    });
    $('#b1').show().text("Retreat").click(function(e){
        window.lin_move=-0.1*(scales[window.arm()[0]+'arm']/100);
        pub_lin_move();
    });
};

function pub_elbow(dir) {
    dir =  (window.arm()=='right') ? -dir : dir; //Catch reflection, switch value for left side
    var action = (dir == 1) ? 'Raise ' : 'Lower ';
    node.publish('wt_adjust_elbow_'+window.arm(),'std_msgs/Float32', json({"data":dir}));
    log('Sending command to ' + action + window.arm().toUpperCase() + ' elbow')
};

function pub_arm_joints(angles){
	//angles.velocities = [];
    node.publish('wt_'+window.arm()+'_arm_angle_commands', 'trajectory_msgs/JointTrajectoryPoint', json(angles))
};

function teleop_wrist() {
    log('Controlling '+window.arm().toUpperCase()+' Hand');
    $('#slider').unbind("slidestop");
    $('#slider').bind("slidestop", function(event,ui){scales[window.arm()[0]+'wrist'] = $('#slider').slider("value")});
    $('#slider').show().slider("option", "value", scales[window.arm()[0]+'wrist']);
    $('.bpd').unbind();

    $("#tp").unbind().show();
    $("#tp").click(function(e){
        x = (e.pageX - Math.round(this.width/2) - this.x);
        y = (e.pageY - Math.round(this.height/2) - this.y);
        var joint_goals = arm_joints[window.arm()];
        joint_goals.positions[4] += x*0.0107;
        joint_goals.positions[5] -= y*(Math.PI/200);
        pub_arm_joints(joint_goals)
    });

    $('#b9').show().text("Hand Roll Right").click(function(e){
        joint_goals = arm_joints[window.arm()];
        joint_goals.positions[6] += scales[window.arm()[0]+'wrist']*(Math.PI/200);
        pub_arm_joints(joint_goals)
    });
    $('#b8').show().text("Wrist Flex Out").click(function(e){
        joint_goals = arm_joints[window.arm()];
        joint_goals.positions[5] += scales[window.arm()[0]+'wrist']*0.0107;
        pub_arm_joints(joint_goals)
    });
    $('#b7').show().text("Hand Roll Left").click(function(e){
        joint_goals = arm_joints[window.arm()];
        joint_goals.positions[6] -= scales[window.arm()[0]+'wrist']*(Math.PI/200);
        pub_arm_joints(joint_goals)
    });
    $('#b6').show().text("Arm Roll Right").click(function(e){
        joint_goals = arm_joints[window.arm()];
        joint_goals.positions[4] += scales[window.arm()[0]+'wrist']*(Math.PI/200);
        pub_arm_joints(joint_goals)
    });
    $('#b5').hide()
    $('#b4').show().text("Arm Roll Left").click(function(e){
        joint_goals = arm_joints[window.arm()];
        joint_goals.positions[4] -= scales[window.arm()[0]+'wrist']*0.0107;
        pub_arm_joints(joint_goals)
    });
    $('#b3').show().text("Raise Elbow").click(function(e){
        pub_elbow(0.01*scales[window.arm()[0]+'wrist'])
    });
    $('#b2').show().text("Wrist Flex In").click(function(e){ 
        joint_goals = arm_joints[window.arm()];
        joint_goals.positions[5] -= scales[window.arm()[0]+'wrist']*(Math.PI/200);
        pub_arm_joints(joint_goals)
    });
    $('#b1').show().text("Lower Elbow").click(function(e){
        pub_elbow(-0.01*scales[window.arm()[0]+'wrist'])
    });
};

function pub_torso(tz){
    var dir = (tz < window.torso_state) ? 'Lowering' : 'Raising';
    log(dir+" Torso");
	node.publish('torso_controller/position_joint_action/goal',
                 'pr2_controllers_msgs/SingleJointPositionActionGoal',
                 json({'goal':{'position':tz}})
                )
};

function pub_head_traj(head_traj_goal, dist){ //Send pan/tilt trajectory commands to head
		if (head_traj_goal.goal.trajectory.points[0].positions[0] < -2.70) {head_traj_goal.goal.trajectory.points[0].positions[0] = -2.70} 
		if (head_traj_goal.goal.trajectory.points[0].positions[0] > 2.70) {head_traj_goal.goal.trajectory.points[0].positions[0] = 2.70}
		if (head_traj_goal.goal.trajectory.points[0].positions[1] < -0.5) {head_traj_goal.goal.trajectory.points[0].positions[1] = -0.5}
		if (head_traj_goal.goal.trajectory.points[0].positions[1] > 1.4) {head_traj_goal.goal.trajectory.points[0].positions[1] = 1.4}
		head_traj_goal.goal.trajectory.joint_names = window.head_joints;
		head_traj_goal.goal.trajectory.points[0].velocities = [0, 0];
		head_traj_goal.goal.trajectory.points[0].time_from_start.secs = Math.max(4*dist, 1);
  		node.publish('head_traj_controller/joint_trajectory_action/goal', 'pr2_controllers_msgs/JointTrajectoryActionGoal', json(head_traj_goal));
};

function pub_head_goal(x,y,z,frame) { //Send 3d point to look at using kinect
	node.publish('head_traj_controller/point_head_action/goal', 'pr2_controllers_msgs/PointHeadActionGoal', json(
		{  'goal':{'target':{'header':{'frame_id':frame },
				             'point':{'x':x, 'y':y, 'z':z}},
                   'pointing_axis':{'x':0, 'y':0, 'z':1},
                   'pointing_frame':window.pointing_frame,
                   'max_velocity':0.35}}))
	//log("Sending command to looking at "+x.toString() +", "+y.toString()+", "+z.toString()+" in "+frame);
};

function teleop_head() {
	window.head_pub = window.clearInterval(head_pub);
	log('Controlling Head');
	$('#slider').unbind("slidestop");
	$('#slider').bind("slidestop", function(event,ui){scales.head = $('#slider').slider("value")});
	$('#slider').show().slider("option", "value", scales.head);
	
	$("#tp").unbind().show();
	$("#tp").click(function(e){
		window.head_pub = window.clearInterval(head_pub);
		x = (e.pageX - Math.round(this.width/2) - this.x)/200;
		y = (e.pageY - Math.round(this.height/2) - this.y)/200;
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head_state;
		head_traj_goal.goal.trajectory.points[0].positions[0] -= x;
		head_traj_goal.goal.trajectory.points[0].positions[1] += y;
                pub_head_traj(head_traj_goal, Math.sqrt(x*x+y*y));
	});
	
	$('.bpd').unbind();
	$('#b9').hide(); 
	$('#b8').show().text("^").click(function(e){//head up 
		window.head_pub = window.clearInterval(head_pub);
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head_state;
		head_traj_goal.goal.trajectory.points[0].positions[1] -= scales.head/150;
                pub_head_traj(head_traj_goal, scales.head/150);
	});
	$('#b7').hide();
	$('#b6').show().text(">").click(function(e){ //head right
		window.head_pub = window.clearInterval(head_pub);
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head_state;
		head_traj_goal.goal.trajectory.points[0].positions[0] -= scales.head/150;
                pub_head_traj(head_traj_goal, scales.head/150);
	});
	$('#b5').show().text("_|_").click(function(e){ //center head to (0,0)
		window.head_pub = window.clearInterval(head_pub);
        pub_head_goal(0.8, 0.0, -0.25, '/base_footprint');
	});
	$('#b4').show().text("<").click(function(e){ //head left
		window.head_pub = window.clearInterval(head_pub);
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head_state;
		head_traj_goal.goal.trajectory.points[0].positions[0] += scales.head/150;
                pub_head_traj(head_traj_goal, scales.head/150);
	});
	$('#b3').show().text("Track Right Hand").click(function(e){
		window.head_pub = window.clearInterval(head_pub);
		window.head_pub = window.setInterval("pub_head_goal(0,0,0,'r_gripper_tool_frame');",200);
	});	
  	$('#b2').show().text("v").click(function(e){ //head down
		window.head_pub = window.clearInterval(head_pub);
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head_state;
		head_traj_goal.goal.trajectory.points[0].positions[1] += scales.head/150;
                pub_head_traj(head_traj_goal, scales.head/150);
	});
	$('#b1').show().text("Track Left Hand").click(function(e){
		window.head_pub = window.clearInterval(head_pub);
		window.head_pub = window.setInterval("pub_head_goal(0,0,0,'l_gripper_tool_frame');",200);
	});
};

function pub_Twist(bx,by,bz) {
          node.publish('base_controller/command', 'geometry_msgs/Twist',
                    '{"linear":{"x":' + bx + ',"y":' + by + ',"z":0}, "angular":{"x":0,"y":0,"z":' + bz + '}}');
};

function teleop_base() {
	window.base_pub = window.clearInterval(base_pub);
	window.base_pub = setInterval("pub_Twist(window.bx,window.by,window.bz)", 150);
	log("Controlling Base");
	$('#slider').unbind("slidestop");
	$('#slider').bind("slidestop", function(event,ui){scales.base = $('#slider').slider("value")});
	$('#slider').show().slider("option", "value", scales.base);
	
	$("#tp").unbind().hide();
/*// Control Mappings for the touchpad for moving the base: Disabled because of occasional 'runaway' behavior, as browser registers a click-and-hold as a drag and drop  of the touchpad image, and so fails to register a mouse-up.
	$("#tp").mousedown(function(e){
		window.by -= 0.002*(e.pageX - Math.round(this.width/2) - this.x);
		window.bx -= 0.002*(e.pageY - Math.round(this.height/2) - this.y);
	}).mouseout(function(e){window.bx=0; window.by=0}).mouseup(function(e){window.bx=0; window.by=0});;
*/	
	$('.bpd').unbind();
	$('#b9').hide()
  	$('#b8').show().text("^").mousedown(function(e){// base forward 
		window.bx = 0.002*scales.base;
		}).mouseout(function(e){window.bx=0}).mouseup(function(e){window.bx=0});
		
	$('#b7').hide()
	$('#b6').show().text(">").mousedown(function(e){ //base right
   		window.by = -0.002*scales.base;
		}).mouseout(function(e){window.by=0}).mouseup(function(e){window.by=0});
	
	$('#b5').hide();
	$('#b4').show().text("<").mousedown(function(e){ //base left
   		window.by = 0.002*scales.base;
		}).mouseout(function(e){window.by=0}).mouseup(function(e){window.by=0});

  	$('#b3').show().text("Turn Right").mousedown(function(e){ //base rot right (cw)
   		window.bz = -0.006*scales.base;
		}).mouseout(function(e){window.bz=0}).mouseup(function(e){window.bz=0});

	$('#b2').show().text("v").mousedown(function(e){ // base backward
   		window.bx = -0.002*scales.base;
		}).mouseout(function(e){window.bx=0}).mouseup(function(e){window.bx=0});

   	$('#b1').show().text("Turn Left").mousedown(function(e){ //base rot left (ccw)
   		window.bz = 0.006*scales.base;
		}).mouseout(function(e){window.bz=0}).mouseup(function(e){window.bz=0});
};

function speak(text){
		node.publish('wt_speech', 'std_msgs/String', json({'data':text}));
		log('\"' + text +'\"'); 
};

//funnction tuck_arms(arm){
//      if (arm == 'r'){
//          log('Sending Tuck Right Arm');
//          node.publish('wt_tuck_arms', 'std_msgs/String', json({'data':'right'}));
//      } else if (arm == 'l') {
//          log('Sending Tuck Left Arm');
//          node.publish('wt_tuck_arms', 'std_msgs/String', json({'data':'left'}));
//      } else {
//          log('Sending Tuck Both Arms')
//          node.publish('wt_tuck_arms', 'std_msgs/String', json({'data':'both'}));
//      };
//};

function toggle_motors(command) { //command = 'halt' or 'reset'
	node.rosjs.callService('/pr2_etherCAT/'+command+'_motors', json(''), nop);
};

function set_camera(cam) {document.getElementById('video').src='http://'+ROBOT+':8080/?topic=/'+cam+'?width=640?height=480'
//if (cam=='/arrow_overlaid'){window.pointing_frame='openni_rgb_optical_frame';}
//else if (cam=='/wide_stereo/right/image_color'){window.pointing_frame='wide_stereo_optical_frame';}
};

function shave(dir) {node.publish('wt_disc_shaving_step', 'std_msgs/Int8', json({'data':dir}));
                    log("Sending Next Shaving Position");
};

function shave_step(x,y,z) {points = window.gm_point;
                        points.x = x; points.y = y; points.z = z;
                        node.publish('wt_cont_shaving_step', 'geometry_msgs/Point', json(points));
                        log("Sending Adjustment to Shaving Position");
};

function send_shave_location(num) {node.publish('wt_shave_location', 'std_msgs/Int8', json({'data':num}));
                                 log("Sending New Shave Position: "+num.toString());
};

function freeze_cloud() {node.publish('reg_confirm', 'std_msgs/Bool', json({'data':true}))
                        log("Sending command to freeze head pointcloud")
};

function toggle_tool_power() {
    state = !window.tool_state;
    node.publish('ros_switch', 'std_msgs/Bool', json({'data':state}));
    log("Sending Tool Power Toggle");
};

function start(){
    node = new ros.NodeHandle('ws://'+ ROBOT + ':9091');
	node.setOnClose(function(e) {
          log("Disconnected or Can't Connect to " + node.url + ".");
    	});
    	node.setOnError(function(e) {
          log("Unknown error connecting!");
    	});
      	node.setOnOpen(function(e) {   
	  log("Connected to " + node.url + ".");
	  init();
	  });
};
</script>

<style>
.bpd{
text-align:center;
height:70px;
width:70px;} 
.cont_sel{
min-height:40px;
width:100%;}
.vid_sel{
min-height:30px;
width:100%
}
.act_menu{
text-align:center;
height:60px;
width:100px;
}
.shave_acts{
text-align:center;
height:60px;
width:100px;
}
</style>

</head>
  <body onload="start()">
<table>
  <tr>
    <td colspan='7'> <!-- Start Cell for video -->
      <div id='video_container' style="position:relative; height:480; width:640;">
        <div style="position:absolute; height:100%; width:100%; left:0; top:0;" onclick="image_click(event);"> </div>
        <iframe id='video' title="Video Stream from the PR2" style="height:100%; width:100%; left:0; top:0; border-style:none;">You Broswer does not support iFrames</iframe>
      </div>
    </td><!-- End Cell for video -->
    <td>
      <div> <!-- Start Force-Torque Set/Feedback Block -->
      <table border=1>
        <tr>
          <td colspan=2 align='center'>Force</td>
        </tr><tr>
        </tr><tr>
          <td colspan=2 align='center'> 0-20 N </td>
        </tr><tr>
          <td align='center'><div id='force_set' style="height:360px"></div></td>
          <td align='center'><div id='force_view' style="height:360px"></div></td>
        </tr><tr>
          <td align='center'> Set </td>
          <td align='center'> Felt </td>
        </tr>
      </table>
      </div> <!-- End Force-Torque Set/Feedback Block -->
    </td>
    <td>
      <table>
        <tr>
          <td>
            <button id="shave_start" class='act_menu' type="button" onclick="$('#bpd2, #head_nav_goal_flag, #shave_select, #shave_end, #tool_power').show(); $(this).hide(); $('#tp').hide();">Shave</button>
            <button id="shave_end" class='act_menu' type="button" onclick="$('#bpd2, #shave_select, #tool_power').hide(); $('#tp, #shave_start').show();$(this).hide()">End Shaving</button>
          </td>
       </tr>
       <tr><td><hr></td></tr>
       <tr>
         <td><button id="head_nav_goal_flag" class='shave_acts' type="button" onclick="window.img_act='head_nav_goal'; $('#init_head_flag').show(); $(this).hide()">Approach (Click Cheek)</button></td>
       </tr><tr>
        <td><button id="init_head_flag" class='shave_acts' type="button" onclick="window.img_act='init_head_cloud'; $('#freeze_cloud').show(); $(this).hide();">Initialize Head Model (Click Cheek)</button></td>
       </tr><tr>
         <td><button id="freeze_cloud" class='shave_acts' type="button" onclick="freeze_cloud(); $(this).hide();">Freeze Pointcloud</button></td>
        </tr>
      <tr>
        <td>
<div id='shave_select'>  <!--Shaving Selection Drop-Down and Entry -->
        <table id='shave_select'>
        <tr>
          <td>
            <select id='shave_list'>
              <option value=0>Near Ear</option>
              <option value=1>Upper Cheek</option>
              <option value=2>Middle Cheek</option>
              <option value=3>Jaw</option>
              <option value=4>Neck</option>
              <option value=5>Nose</option>
              <option value=6>Chin</option>
              <option value=7>Corner of Mouth</option>
	        </select>
          </td>
          </tr><tr>
          <td><button id="send_shave_select" type="button" onclick="send_shave_location(document.getElementById('shave_list').selectedIndex)">Shave Selection</button></td>
	    </tr>
	</table>
  </div>  <!--End Shaving Drop-Down -->
  </td></tr>
      <tr><td><button  class='shave_acts' id="tool_power" type="button" value="-1" onclick="toggle_tool_power()">Start/Stop Tool</button></td></tr>
      </td>
      </table>
    <td>
  <tr>
    <td> Camera: </td> <!-- Start Cell for Camera Selection -->
	  <td><select onchange="set_camera($(this).val());">
	      <!--<option value="/kinect_head/rgb/image_color">Kinect Camera</option>-->
		  <option value="/wide_stereo/right/image_color">Wide Stereo Camera</option>
	      <option value="/arrow_overlaid">Kinect Camera</option>
		  <option value="/l_forearm_cam/image_color_rotated">Left Forearm Camera</option>
		  <option value="/r_forearm_cam/image_color_rotated">Right Forearm Camera</option>
      </select></td> <!-- End Cell for Camera Selection -->
     
     <td>On Image Click:</td> <!-- Start Cell for Image Action Selection -->
     <td><select id='img_act_select' onchange="window.img_act=$(this).val()">
         <option id="looking" selected='selected' value='looking'>Look</option>
         <option id="na" value='norm_approach'>Normal Approach</option>
         <option id="touch" value='touch'>Touch</option>
         <!--<option id="wipe" value='wipe'>Wipe</option>-->
         <!--<option id="swipe" value='swipe'>Swipe</option>-->
         <!--<option id="poke" value='poke'>Poke</option>-->
         <!--<option id="surf_wipe" value='surf_wipe'>Surface Wipe</option>-->
         <!--<option id="grasp" value='grasp'>Grasp</option>-->
         <!--<option id="reactive_grasp" value='reactive_grasp'>Reactive Grasp</option>-->
         <!--<option id="contact_approach" value='contact_approach'>Approach until Contact</option>-->
         <!--<option id="hfc_contact_approach" value='hfc_contact_approach'>Approach until Contact HFC</option>
         <option id="hfc_swipe" value='hfc_swipe'>Swipe HFC</option>
         <option id="hfc_wipe" value='hfc_wipe'>Wipe HFC</option>-->
     </select></td> <!-- End Cell for Image Action Selection -->
     <td>Hand:</td> <!-- Start Cell for Hand Selection -->
     <td>
        <div id='arm_sel'>
          <input type='radio' id='l_arm' name='arm_sel' value='left' checked='checked'"/><label for='l_arm'>Left</label>
          <input type='radio' id='r_arm' name='arm_sel' value='right'/><label for='r_arm'">Right</label>
        </div>
      </td>
  </tr>
  <!--<tr>
     <td colspan=2><button id="l_arm_controller" type="button" value="l_arm_controller" onclick="node.publish('wt_cont_switch', 'std_msgs/String', json({'data':'l_arm_controller'}));"> Joint Angle Controller (Default) </button></td>
     <td colspan=2><button id="l_cart" type="button" value="l_cart" onclick="node.publish('wt_cont_switch', 'std_msgs/String', json({'data':'l_cart'}));"> Hybrid Force Controller </button></td>
  </tr>-->
    
</table>
<!-- ABANDONED BUTTONS: DRIVING AND ARM TUCKING -->

<div id="head_pos_out"></div>

<table><tr><td> <!-- Begin Gross Formatting-->
<div>
  <table>
    <tr><td colspan="2"><button class="cont_sel" id="cont_head" type="button" value="cont_head" onclick="teleop_head()">Control Head</button></td></tr>
    <tr>
       <td><button class="cont_sel" id="cont_l_arm" type="button" value="cont_l_arm" onclick="$('#l_arm').click(); teleop_arm();">Control Left Arm </button></td>
       <td><button class="cont_sel" id="cont_r_arm" type="button" value="cont_r_arm" onclick="$('#r_arm').click(); teleop_arm();">Control Right Arm </button></td>
    </tr>
    <tr>
       <td><button class="cont_sel" id="cont_l_hand" type="button" value="cont_l_hand" onclick="$('#l_arm').click(); teleop_wrist()">Control Left Hand</button></td>
       <td><button class="cont_sel" id="cont_r_hand" type="button" value="cont_r_hand" onclick="$('#r_arm').click(); teleop_wrist()">Control Right Hand </button></td>
    </tr>
    <tr><td colspan="2"><button class="cont_sel" id="cont_base" type="button" value="cont_base" onclick="teleop_base()">Control Base</button></td></tr>
    <tr>
    </tr>
 </table>
</div>
  <div id=speech_select>  <!--Speak Button and Text Input -->
        <table><tr>
          <form action=''>
             <td><button id="submit_text" type="button">Speak:</button></td>
             <td><input id="txt2say" type="text" style="height:auto;width:105%"/></td>
          </form>
        </tr>
	<tr>
	    <td>Phrases:</td>
	    <td><select onchange="speak($(this).val()); $('#txt2say').val($(this).val())">
		<option value="Yes">Yes</option>
		<option value="No">No</option>
		<option value="Maybe">Maybe</option>
		<option value="OK">Ok</option>
		<option value="k">k</option>
		<option value="Board Please">Board Please</option>
		<option value="I don't know">I Don't Know</option>
		<option value="I don't care">I Don't Care</option>
		<option value="One Moment">One Moment</option>
		<option value="Please">Please</option>
		<option value="Thank You">Thank You</option>
		<option value="I agree">I agree</option>
		<option value="I disagree">I disagree</option>
		<option value="A lot">A lot</option>
		<option value="A little">A little</option>
		<option value="Hello">Hello</option>
		<option value="Goodbye">Goodbye</option>
	    </select></td>
	</tr>
	</table>
  </div>  <!--End Speak Button + Text -->

</td><td> <!-- Gross Formatting-->

<div id='bpd1'> <!--Buttonpad Controls-->
  <table>
    <tr><td rowspan="4">
      <div style="height:215px" id="slider"></div>
    </td></tr>
    <tr>
      <td><button class="bpd" id="b7" type="button" value=1> Down </button></td>
      <td><button class="bpd" id="b8" type="button" value=1> ^ </button></td>
      <td><button class="bpd" id="b9" type="button" value=1> Up </button></td>
    </tr>
    <tr>
      <td><button class="bpd" id="b4" type="button" value="1"><</button></td>
      <td><button class="bpd" id="b5" type="button" value=1> 0 </button></td>
      <td><button class="bpd" id="b6" type="button" value="-1">></button></td>
    </tr>
    <tr>
      <td><button class="bpd" id="b1" type="button" value="-1">Turn Left</button></td>
      <td><button class="bpd" id="b2" type="button" value="-1">v</button></td>
      <td><button class="bpd" id="b3" type="button" value="-1">Turn Right</button></td>
    </tr>
  </table>
</div> <!--END buttonpad controls -->
</td><td>
<div id='bpd2'> <!--Buttonpad Controls-->
  <table>
    <tr><td rowspan="4">
      <div style="height:215px" id="slider"></div>
    </td></tr>
    <tr>
      <td><button class="bpd" id="bpd2_b7" type="button" value=1 onclick="shave_step(0,0,-1)"> Ellipse In </button></td>
      <td><button class="bpd" id="bpd2_b8" type="button" value=1 onclick="shave_step(0,1,0)"> ^ </button></td>
      <td><button class="bpd" id="bpd2_b9" type="button" value=1 onclick="shave_step(0,0,1)"> Ellipse Out </button></td>
    </tr>
    <tr>
      <td><button class="bpd" id="bpd2_b4" type="button" value="1" onclick="shave_step(-1,0,0)"><</button></td>
      <td><button class="bpd" id="bpd2_b5" type="button" value=1 onclick="shave(0)"> Current </button></td>
      <td><button class="bpd" id="bpd2_b6" type="button" value="-1" onclick="shave_step(1,0,0)">></button></td>
    </tr>
    <tr>
      <td><button class="bpd" id="bpd2_b1" type="button" value=1 onclick="shave(-1)"> Prev. </button></td>
      <td><button class="bpd" id="bpd2_b2" type="button" value="-1" onclick="shave_step(0,-1,0)">v</button></td>
      <td><button class="bpd" id="bpd2_b3" type="button" value=1 onclick="shave(1)"> Next </button></td>
    </tr>
  </table>
</div> <!--END buttonpad controls -->
</td><td>
     <img id="tp" src=touchpad.jpg title="Click here for 2D Control of the selected robot part" style="border-style:solid; border-width:3px height:201px; width:201px;">
</td>
<td rowspan='4'> <!-- Gross Formatting-->
<div id='gripper_controls'>
  <table border='1'>
    <th colspan='2' align='center'> Grippers </th>
    <th align='center'>Torso</th>
    <tr>
      <td align='center'>Left</td>
      <td align='center'>Right</td>
      <td align='center'>U/D</td>
    </tr>
    <tr>
      <td>
        <button id='lg_release' onclick='gripper_release("l");'>Place</button>
      </td><td>
        <button id='rg_release' onclick='gripper_release("r");'>Place</button>
      </td><td>
        <button id='torso_max' onclick='pub_torso(0.3);'>Max</button>
      </td>
    </tr>
    <tr>
      <td rowspan="1" align='center'><div style="margin:5px;height:150px" id="lg_slider"></div></td>
      <td rowspan="1" align='center'><div style="margin:5px;height:150px" id="rg_slider"></div></td>
      <td rowspan="1" align='center'>
        <div style="margin: 5 auto; height:150px" id="torso_slider"></div>
      </td>
    </tr>
    <tr>
      <td>
        <button id='lg_grab' onclick='gripper_grab("l");'>Grab</button>
      </td><td>
        <button id='rg_grab' onclick='gripper_grab("r");'>Grab</button>
      </td><td>
        <button id='torso_min' onclick='pub_torso(0);'>Min</button>
      </td>
    </tr>
  </table>
</div>
</tr>
<tr><td colspan='4'> <!-- Gross Formating-->
<div id="console"></div>
</td><td colspan='2'> <!-- Gross Formating-->
<tr><td colspan='4'>
  <button id="stop" type="button" style="color:red;background-color:gray;font:bold;height:auto;border-style:none;height:30px;width:100%;" onclick="toggle_motors('halt'); $(':button:visible:not(#reset)').fadeTo(1,0.4); $('#reset').show(); log('YOU\'VE STOPPED THE ROBOT! Please click \'REACTIVATE\' to reset.')">STOP ROBOT! </button> 
  </td>
</tr><tr>
  <td colspan='4'>
    <button id="reset" type="button" style="color:white;background-color:green;font:bold;height:30px;width:100%" onclick="toggle_motors('reset'); $(':button:visible').fadeTo(1,1); $(this).hide(); log('Operation Resumed.');">REACTIVATE</button>
 </td>
</tr></table> <!--END Gross Formating-->
</body>
</html>
